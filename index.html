<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–û—Ü—ñ–Ω–∫–∞ –∑–∞–≥—Ä–æ–∑ –æ–±'—î–∫—Ç–∞–º</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Turf.js -->
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
  </style>
</head>
<body>

<div id="map"></div>

<script>
  // =============================
  // 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø –ö–ê–†–¢–ò
  // =============================
  const map = L.map('map').setView([49.0, 32.0], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  let frontlineLayer;

  // =============================
  // 2. –§–£–ù–ö–¶–Ü–á
  // =============================

  function getThreat(distance) {
    if (distance < 10) return { text: 'üî¥ –í–∏—Å–æ–∫–∞', color: 'red' };
    if (distance < 30) return { text: 'üü° –°–µ—Ä–µ–¥–Ω—è', color: 'orange' };
    return { text: 'üü¢ –ù–∏–∑—å–∫–∞', color: 'green' };
  }

  function loadFrontline() {
    fetch('frontline.geojson?_=' + Date.now())
      .then(res => res.json())
      .then(data => {
        if (frontlineLayer) map.removeLayer(frontlineLayer);

        frontlineLayer = L.geoJSON(data, {
          style: {
            color: 'red',
            weight: 3
          }
        }).addTo(map);

        loadObjects(data);
      });
  }

  function loadObjects(frontlineData) {
    fetch('objects.geojson')
      .then(res => res.json())
      .then(objects => {
        L.geoJSON(objects, {
          pointToLayer: function (feature, latlng) {
            const point = turf.point(feature.geometry.coordinates);
            const line = frontlineData.features[0];

            const distance = turf.pointToLineDistance(
              point,
              line,
              { units: 'kilometers' }
            );

            const threat = getThreat(distance);

            const marker = L.circleMarker(latlng, {
              radius: 8,
              fillColor: threat.color,
              color: '#000',
              weight: 1,
              fillOpacity: 0.9
            });

            marker.bindPopup(`
              <b>${feature.properties.id}</b><br>
              ${feature.properties.name}<br><br>
              üìè –î–æ —Ñ—Ä–æ–Ω—Ç—É: <b>${distance.toFixed(1)} –∫–º</b><br>
              ‚ö†Ô∏è –ó–∞–≥—Ä–æ–∑–∞: <b>${threat.text}</b><br>
              üïí –û–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString()}
            `);

            return marker;
          }
        }).addTo(map);
      });
  }

  function loadZones() {
    fetch('zones.geojson')
      .then(res => res.json())
      .then(zones => {
        L.geoJSON(zones, {
          style: {
            color: 'orange',
            weight: 2,
            fillOpacity: 0.2
          }
        }).addTo(map);
      });
  }

  // =============================
  // 3. –ó–ê–ü–£–°–ö
  // =============================
  loadZones();
  loadFrontline();

  // –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ—Ä–æ–Ω—Ç—É –∫–æ–∂–Ω—ñ 15 —Ö–≤
  setInterval(loadFrontline, 15 * 60 * 1000);
</script>

</body>
</html>
